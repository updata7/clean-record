name: Build CleanRecord (Universal macOS App)

on:
  push:
    branches: [ main ]
  release:
    types: [ created ]
  workflow_dispatch:

permissions:
  contents: write   # ç”¨äº release ä¸Šä¼ æ–‡ä»¶ï¼ˆä¸éœ€è¦è‡ªå»º tokenï¼‰

jobs:
  build:
    name: Build Universal macOS App
    runs-on: macos-latest
    timeout-minutes: 60

    env:
      APP_NAME: CleanRecord
      MACOSX_DEPLOYMENT_TARGET: "11.0"   # ğŸ‘ˆ éå¸¸å…³é”®ï¼Œé¿å…ç³»ç»Ÿç‰ˆæœ¬ä¸å…¼å®¹

    steps:
      # 1ï¸âƒ£ æ‹‰ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Xcode
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show build environment
        run: |
          sw_vers
          uname -m
          xcodebuild -version

      # 3ï¸âƒ£ ç¼–è¯‘ï¼ˆUniversalï¼‰
      - name: Build Universal Binary
        run: |
          set -e
          xcodebuild \
            -scheme ${APP_NAME} \
            -configuration Release \
            -destination 'platform=macOS' \
            ARCHS="arm64 x86_64" \
            ONLY_ACTIVE_ARCH=NO \
            MACOSX_DEPLOYMENT_TARGET=${MACOSX_DEPLOYMENT_TARGET} \
            build

      # 4ï¸âƒ£ æ‰“åŒ… .appï¼ˆä½ å·²æœ‰ Package.shï¼‰
      - name: Package .app bundle
        run: |
          chmod +x Package.sh
          ./Package.sh

      # 5ï¸âƒ£ æ ¡éªŒäº§ç‰©ï¼ˆéå¸¸é‡è¦ï¼‰
      - name: Verify App
        run: |
          APP="build/${APP_NAME}.app"
          if [ ! -d "$APP" ]; then
            echo "âŒ ${APP_NAME}.app not found"
            exit 1
          fi

          echo "âœ… App exists"
          echo "ğŸ“¦ Binary info:"
          file "$APP/Contents/MacOS/${APP_NAME}"

          echo "ğŸ“¦ Min macOS version:"
          otool -l "$APP/Contents/MacOS/${APP_NAME}" | grep -A2 LC_BUILD_VERSION || true

      # 6ï¸âƒ£ æ‰“ zipï¼ˆä¾›ä¸‹è½½ï¼‰
      - name: Create ZIP
        run: |
          cd build
          zip -r ${APP_NAME}-macOS-universal.zip ${APP_NAME}.app
          cd ..

      # 7ï¸âƒ£ ä¸Šä¼  Actions Artifactï¼ˆpush å°±æœ‰ï¼‰
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${APP_NAME}-macOS-universal
          path: build/${APP_NAME}-macOS-universal.zip
          retention-days: 30

      # 8ï¸âƒ£ å‘å¸ƒåˆ° Releaseï¼ˆåªæœ‰ release äº‹ä»¶æ‰èµ°ï¼‰
      - name: Upload to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: build/${APP_NAME}-macOS-universal.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
